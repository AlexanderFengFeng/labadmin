#!/usr/bin/env python

from __future__ import division

from os import makedirs
from os.path import join

import click
from dateutil.relativedelta import relativedelta

from knimin.lib.mail import send_email
from knimin.lib.util import combine_barcodes
from knimin import db

__author__ = "Adam Robbins-Pianka"
__copyright__ = "Copyright 2009-2015, QIIME Web Analysis"
__credits__ = ["Adam Robbins-Pianka"]
__license__ = "GPL"
__version__ = "1.0.0"
__maintainer__ = ["Adam Robbins-Pianka"]
__email__ = "adam.robbinspianka@colorado.edu"
__status__ = "Development"


@click.group()
def cli():
    """All commands in this click group will be available at the top level
    """
    pass


@cli.command()
@click.option('-i', '--input-file', required=False,
              type=click.File('U'),
              help="Path to file containing barcodes, one per line")
@click.option('-o', '--output-dir', required=True,
              type=click.Path(exists=False, readable=True, writable=True))
@click.argument('barcodes', nargs=-1)
def pulldown(input_file, output_dir, barcodes):
    if not barcodes and input_file is None:
        click.echo("You must specify either an input file (-i) or at least "
                   "one barcode")

    all_barcodes = combine_barcodes(barcodes, input_file)
    metadata, failures = db.pulldown(all_barcodes)
    makedirs(output_dir)

    for survey, barcodes_responses in metadata.items():
        with open(join(output_dir,
                       'survey_%d_md.txt' % survey), 'w') as outfile:
            outfile.write(barcodes_responses)

    if failures:
        click.echo("The following barcodes were not retrieved for any survey:"
                   "\n%s\n" % '\n'.join(sorted(failures)))


@cli.command('email-unconsented')
def email_unconsented():
    message = """Hello from the American Gut team!

This is a friendly reminder that you have not yet associated your sample 
barcode %s with a consent form. By law, we are not permitted to work with your 
sample until you have associated your sample with a consent form. To associate 
your sample, please login to the participant portal 
(https://microbio.me/americangut for American Gut samples and 
https://microbio.me/britishgut for British Gut samples) and click on 
"Associate/Log Sample" on the bottom of the left hand navigation bar. 
Then choose the appropriate sample source and complete the required details 
(sample type, collection date, and collection time). Please note that if your 
sample has not been associated to a consent form within six months after we 
receive it in our laboratory (by %s), it will be destroyed and you will not 
receive a refund or replacement kit. We thank you for your understanding.

The American Gut Team
"""

    for barcode, scan_date, email in db.get_unconsented():
        msg = message % (barcode, str(scan_date + relativedelta(months=+6)))
        send_email(msg, 'You have Un-associated American Gut samples!',
                   recipient=email)

if __name__ == '__main__':
    cli()
